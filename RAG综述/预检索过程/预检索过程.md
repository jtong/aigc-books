## **预检索过程**

#### 概述
- 主要关注优化索引结构和原始查询。
- 主要目标是提高被索引内容的质量和检索效率。
- 主要涉及两个方面
	- **索引优化**
	- **查询优化**

#### **索引优化**
				
##### **增强数据粒度**

**增强数据粒度**：指的是将文档分割成更细粒度的块，以便更精确地捕捉相关信息。具体方法包括：
- **固定长度分块**：将文档按固定数量的tokens（如100、256、512）进行分割。较小的块能够更精细地捕捉信息，但可能会丢失上下文；较大的块则包含更多上下文，但可能引入噪音。
- [**滑动窗口**](预检索过程/索引优化/增强数据粒度/滑动窗口.md)：使用[滑动窗口](预检索过程/索引优化/增强数据粒度/滑动窗口.md)技术，以重叠的方式分割文档。这种方法可以确保块之间的连续性，避免信息丢失。  
- [**递归分割**](预检索过程/索引优化/增强数据粒度/递归分割.md)：首先进行粗略分割，然后再对重要段落进行细粒度分割。这种方法结合了大块和小块的优点。						

##### **优化索引结构**

**优化索引结构**的目标是通过改进索引的组织方式，使检索过程更加高效。具体策略包括：

- **层次化索引结构**：建立一个多层次的索引，将文档块按父子关系排列。每个节点存储数据摘要，便于快速遍历和定位相关信息。
- **知识图谱索引**：使用知识图谱（KG）构建索引，表示文档中不同概念和实体之间的关系。这种方法有助于保持一致性，减少幻觉的可能性。

##### **元数据附加**

**元数据附加**是指为每个块添加额外的信息，以便在检索时进行过滤和排序。常见的元数据包括：
- **时间戳**：记录文档块的创建或最后修改时间，允许时间感知检索。
- **类别**：标记文档块所属的类别或主题，便于分类检索。
- **作者**：记录文档块的作者信息，有助于来源验证。
- **位置**：如页码或段落编号，便于定位原始文档内容。
- 此外，还可以通过人工构建元数据来丰富检索内容，例如：
  - **段落摘要**：为每个块生成简要摘要，帮助快速理解内容。
  - **假设问题**：生成可以由文档回答的问题，作为检索过程中的参考。
##### **对齐优化**
**对齐优化**旨在确保索引块与查询之间的语义一致性。具体方法包括：
- **查询映射**：将用户查询映射到与索引内容更紧密相关的表达方式。
- **语义对齐**：使用预训练语言模型（如BERT）对文档块进行编码，确保它们的语义表示与查询一致。
##### **混合检索**
**混合检索**结合了传统关键字检索和向量检索的优点，利用两者的互补特性来提高检索性能。具体策略包括：
- **稀疏检索**：使用稀疏编码器（如BM25）进行初步搜索，提供基础的检索结果。
- **密集检索**：使用密集检索模型（如BERT等预训练语言模型）进行语义搜索，确保更高的相关性。
- **融合策略**：将稀疏和密集检索的结果融合起来，通过加权平均或其它方法来综合考虑检索结果的相关性。

#### **查询优化**
- **查询扩展**：通过丰富原始查询的内容，提供更多的上下文信息，以解决查询中可能缺失的细微差别，从而确保生成答案的最佳相关性。常见的查询扩展方法包括：
	- **多查询**：通过提示工程扩展查询，可以让LLM（大型语言模型）生成多个相关查询，然后并行执行这些查询。这些扩展查询是经过精心设计的，不是随机生成的，从而确保每个查询都能补充原始查询的信息。
	- **子查询**：将复杂问题分解为一系列更简单的子问题，这一过程被称为子问题规划。每个子问题都用于补充原始问题的上下文，从而更全面地回答原始问题。常见的方法包括最少到最多提示法，将复杂问题逐步分解为简单子问题。
	- **验证链（CoVe）**：扩展的查询通过LLM进行验证，以减少幻觉（即生成不受支持的内容）。验证过的扩展查询通常表现出更高的可靠性和准确性。
- **查询转换**：核心概念是基于转换后的查询而不是用户的原始查询来进行检索。这种方法可以显著提高检索结果的相关性和准确性。常见的方法包括：
	- **查询重写**：原始查询不总是最佳的检索选择，特别是在现实场景中。因此，可以使用LLM或专门的小型语言模型将原始查询重写为更适合检索的形式。例如，淘宝的BEQUE系统通过查询重写显著提高了长尾查询的召回率。
	- **生成查询**：通过提示工程让LLM根据原始查询生成新的查询进行检索。例如，HyDE方法构建假设文档（假设答案），专注于从答案到答案的嵌入相似性，而不是问题或查询的嵌入相似性。Step-back Prompting方法将原始查询抽象为生成一个高层次概念问题（Step-back问题），并将其与原始查询一起用于检索。
- **查询路由**：基于不同的查询，将其路由到适合的不同RAG管道，适用于适应多样场景的通用RAG系统。主要方法包括：
	- **元数据路由/过滤**：从查询中提取关键词（实体），然后基于关键词和块中的元数据进行过滤，以缩小搜索范围。这种方法确保了检索结果与查询的相关性。
	- **语义路由**：利用查询的语义信息进行路由。例如，Semantic Router方法结合语义和基于元数据的方法进行查询路由，确保检索结果的高相关性和准确性。
