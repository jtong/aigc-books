论文：Retrieval-Augmented Generation for Large Language Models: A Survey	arxiv编号：2312.10997

## 三种范式的RAG

它把RAG分为了三种范式朴素RAG、高级RAG和模块化RAG，是按照发展的阶段分的：

- **朴素RAG**（Naive RAG）: 朴素RAG研究范式代表了最早的方法，随着ChatGPT的广泛采用而逐渐普及。朴素RAG遵循传统的过程，包括索引、检索和生成，这也被称为“检索-阅读”框架。
- **高级RAG**（Advanced RAG）: 高级RAG引入了一些改进，以克服朴素RAG的局限性。重点在于优化检索质量，采用预检索和后检索策略。为了解决索引问题，高级RAG通过使用滑动窗口方法、细粒度分割和元数据的整合来完善其索引技术。此外，它还整合了一些优化方法以简化检索过程。
- **模块化RAG**（Modular RAG）: 模块化RAG架构超越了前两种RAG范式，提供了更大的适应性和灵活性。它整合了多种策略来改进其组件，例如添加用于相似性搜索的搜索模块并通过微调改进检索器。为了应对特定挑战，引入了如重新构建的RAG模块和重新排列的RAG管道等创新。模块化RAG方法的普及日益增长，支持顺序处理和跨组件的一体化端到端训练。尽管与众不同，模块化RAG建立在高级和朴素RAG的基础上，展示了RAG家族内的进步和完善。

将RAG的三个阶段（朴素RAG、高级RAG和模块化RAG）的演变分开讨论具有重要的价值和意义。以下是这种分阶段讨论的几个关键理由：

1. 理解技术进步的过程

**技术演变**：通过分阶段讨论，可以清晰地展示RAG技术从简单到复杂、从基础到高级的演变过程。这有助于理解每个阶段是如何在前一阶段的基础上进行改进和创新的。

2. 识别具体挑战和解决方案

**问题分析**：每个阶段都有其独特的挑战和局限性。通过分阶段讨论，可以详细分析每个阶段面临的问题，并介绍解决这些问题的具体方法。例如：
  - **朴素RAG**：面临检索精度低、生成内容幻觉等问题。
  - **高级RAG**：通过优化检索质量和生成质量来解决朴素RAG的问题。
  - **模块化RAG**：进一步增强系统灵活性和适应性，解决高级RAG中未解决的问题。

3. 提供技术选择的依据

**选择依据**：不同的RAG范式适用于不同的应用场景和需求。通过了解每个阶段的特点和优势，研究人员和工程师可以根据具体需求选择合适的RAG范式。例如：
  - 对于简单的知识检索和生成任务，可以选择朴素RAG。
  - 对于需要高精度和高效检索的复杂任务，可以选择高级RAG。
  - 对于需要高度灵活性和扩展性的应用，可以选择模块化RAG。

4. 推动未来研究和发展

**研究导向**：分阶段讨论有助于识别当前技术的局限性和未来研究的方向。例如，通过分析当前RAG技术的不足，可以确定未来需要解决的问题，如增强系统的鲁棒性、处理更长的上下文、跨模态检索等。

5. 促进技术整合和创新

**技术整合**：通过了解不同阶段的技术特点和发展趋势，可以促进不同技术的整合和创新。例如，将高级RAG的优化策略与模块化RAG的灵活架构结合，可能会产生新的技术突破。

### 对于从事RAG应用开发人员的价值

如果是对于从事RAG（检索增强生成）应用开发的人员来说，理解RAG三个范式（朴素RAG、高级RAG和模块化RAG）的价值至关重要：

- 朴素RAG提供了一个简单且易于实现的基础框架，通过基本的索引、检索和生成流程，可以快速部署基础的检索增强应用，适合初学者和简单任务。
- 高级RAG在此基础上引入了多种优化策略，如预检索和后检索、查询优化和上下文压缩等，显著提高了检索和生成的质量和效率，适合需要高精度和高效检索的复杂任务。
- 模块化RAG则进一步增强了系统的灵活性和适应性，允许通过添加和替换模块来满足特定需求，并支持端到端的训练和多任务处理，适合需要高度灵活性和扩展性的应用场景。

通过理解这三种范式的演变和特点，开发人员可以根据具体需求选择合适的技术方案，从而构建更高效、更精准和更具适应性的RAG系统。

## 朴素RAG

### 主要步骤

- **索引**（Indexing）：首先，对PDF、HTML、Word和Markdown等多种格式的原始数据进行清理和提取，然后将其转换为统一的纯文本格式。为了适应语言模型的上下文限制，文本被分割成较小的可消化块。然后使用嵌入模型将块编码为向量表示并存储在向量数据库中。此步骤对于在后续检索阶段实现高效的相似性搜索至关重要。
- **检索**（Retrieval）：在接收到用户查询后，RAG系统使用索引阶段中使用的相同编码模型将查询转换为向量表示。然后，它计算查询向量与索引语料库中块的向量之间的相似度分数。系统优先选择与查询最相似的前K个块，并将这些块用作提示的扩展上下文。
- **生成**（Generation）：提出的查询和选择的文档被合成为一个连贯的提示，任务是让大型语言模型生成一个答案。根据任务的具体要求，模型的回答方式可能有所不同，允许它从其固有的参数知识中提取信息，或者将其回答限制在提供的文档内。在进行对话的情况下，任何现有的对话历史都可以整合到提示中，从而使模型能够有效地进行多轮对话互动。

### 朴素RAG的明显缺点

- 检索召回精准度低
	- 召回无关块
	- 遗漏关键信息
- 生成偏离上下文
	- 不基于召回信息生成
- 没起到增强作用
	- 不同的信息整合到不同任务的能力不足
	- 可能输出不连贯不一致
	- 冗余
	- 复杂问题不足以获得足够上下文
	- 没有检索到关键信息，导致输出仅仅是片段重复的描述，没有生成洞察或综述

## 高级RAG
高级RAG引入了一些改进，以克服朴素RAG的局限性。重点在于优化检索质量，采用预检索和后检索策略。为了解决索引问题，高级RAG通过使用滑动窗口方法、细粒度分割和元数据的整合来完善其索引技术。此外，它还整合了一些优化方法以简化检索过程。

相对朴素RAG，增加了两个环节：

- **预检索过程**（Pre-retrieval Process）：在这个阶段，主要关注优化索引结构和原始查询。优化索引的目标是提高被索引内容的质量。这涉及到一些策略，如增强数据粒度、优化索引结构、添加元数据、对齐优化和混合检索。而查询优化的目标是使用户的原始问题更加清晰和适合检索任务。常见方法包括查询重写、查询转化、查询扩展等技术。
  
- **后检索过程**（Post-retrieval Process）：一旦检索到相关的上下文，关键是有效地将其与查询整合。后检索过程中的主要方法包括重新排序块和上下文压缩。将检索到的信息重新排序，将最相关的内容重新定位到提示的边缘是一个关键策略。这一概念已在LlamaIndex2、LangChain3和HayStack等框架中实现。直接将所有相关文档输入LLM可能导致信息过载，使关键细节被无关内容稀释。为减轻这一问题，后检索工作集中于选择必要的信息，强调关键部分，并缩短要处理的上下文。

### 预检索过程

**预检索过程**的主要目标是优化索引结构和原始查询，以提高检索质量。这一过程可以分为两个方面：索引优化和查询优化。

1. **索引优化**（Index Optimization）：这是在索引构建阶段进行的，主要关注的是提高被索引内容的质量。具体策略包括：
    - **增强数据粒度**（Enhancing Data Granularity）：将文档分割成更细粒度的块，以便更精确地捕捉相关信息。
    - **优化索引结构**（Optimizing Index Structures）：通过改进索引的组织方式，使检索过程更加高效。
    - **添加元数据**（Adding Metadata）：为每个块添加额外的信息（如时间戳、类别等），以便在检索时进行过滤和排序。
    - **对齐优化**（Alignment Optimization）：确保索引中的块与查询之间的语义一致性。
    - **混合检索**（Mixed Retrieval）：结合传统关键字检索和向量检索，利用两者的优势。

2. **查询优化**（Query Optimization）：这一部分主要针对用户的原始查询进行优化，使其更适合检索任务。常见的方法包括：
    - **查询重写**（Query Rewrite）：使用语言模型重写原始查询，使其更加清晰和具体。
    - **查询转化**（Query Transformation）：将查询转换成另一种形式，以便更好地匹配索引中的内容。
    - **查询扩展**（Query Expansion）：通过添加相关的关键词或子查询来丰富查询内容，增加检索到相关信息的可能性。

### 后检索过程

**后检索过程**的主要目标是有效整合检索到的上下文信息，以便生成更准确和相关的答案。这个过程包括以下几个方面：

1. **重新排序块**（Reranking）：检索到的文档块根据其与查询的相关性进行重新排序。常见的策略有：
    - **基于规则的重新排序**（Rule-based Reranking）：按照预定的规则（如相关性得分、时间戳等）对块进行排序。
    - **基于模型的重新排序**（Model-based Reranking）：使用专门训练的模型（如BERT、Cohere rerank）对块进行排序，确保最相关的内容靠前。

2. **上下文压缩**（Context Compression）：为了避免信息过载，将所有相关文档直接输入LLM可能会导致关键细节被稀释。压缩过程包括：
    - **选择必要的信息**（Selecting Essential Information）：从检索到的文档中挑选出最关键的部分，形成一个简洁的上下文提示。
    - **强调关键部分**（Emphasizing Critical Sections）：确保提示中突出显示最重要的信息，以提高生成答案的质量和相关性。
    - **缩短上下文长度**（Shortening Context Length）：通过删除不相关或冗余的内容，减小输入的长度，使LLM更专注于关键细节。

通过上述的预检索和后检索优化过程，高级RAG能够更好地整合外部知识库的信息，提高生成内容的准确性和相关性，特别是在处理复杂和知识密集型任务时。

## 模块化RAG

模块化RAG架构超越了前两种RAG范式，提供了更大的适应性和灵活性。它整合了多种策略来改进其组件，例如添加用于相似性搜索的搜索模块并通过微调改进检索器。为了应对特定挑战，引入了如重新构建的RAG模块和重新排列的RAG管道等创新。模块化RAG方法的普及日益增长，支持顺序处理和跨组件的一体化端到端训练。尽管与众不同，模块化RAG建立在高级和朴素RAG的基础上，展示了RAG家族内的进步和完善。

### 新模块

模块化RAG框架引入了额外的专门组件，以增强检索和处理能力：

- **搜索模块**（Search Module）：适应特定场景，允许使用LLM生成的代码和查询语言，直接在各种数据源（如搜索引擎、数据库和知识图）中进行搜索。
- **RAG-Fusion**：通过采用多查询策略扩展用户查询，利用并行向量搜索和智能重新排序来发现显性和转化知识，解决了传统搜索的局限性。
- **记忆模块**（Memory Module）：利用LLM的记忆引导检索，通过迭代自增强创建一个无边界的记忆库，更加紧密地与数据分布对齐。
- **路由模块**（Routing Module）：通过选择最优路径，导航不同的数据源，无论是摘要、特定数据库搜索还是合并不同的信息流。
- **预测模块**（Predict Module）：旨在通过直接生成上下文减少冗余和噪声，确保相关性和准确性。
- **任务适配模块**（Task Adapter Module）：使RAG适应各种下游任务，通过少量示例查询生成自动检索提示，创建特定任务的检索器。

这种综合方法不仅简化了检索过程，还显著提高了信息检索的质量和相关性，满足了广泛任务和查询的需求，具有更高的精度和灵活性。

### 新模式

模块化RAG通过允许模块替换或重新配置来应对特定挑战，展示了显著的适应性。这超越了朴素和高级RAG的固定结构，后者以简单的“检索”和“阅读”机制为特征。模块化RAG通过整合新模块或调整现有模块之间的交互流，扩展了这种灵活性，提高了其在不同任务中的适用性。

- **Rewrite-Retrieve-Read**：利用LLM的能力，通过重写模块和LM反馈机制来改进检索查询，从而提高任务性能。
- **Generate-Read**：用LLM生成的内容替代传统检索，强调从模型权重中检索，增强了模型处理知识密集型任务的能力。
- **混合检索策略**（Hybrid Retrieval Strategy）：整合关键字、语义和向量搜索，以满足不同查询的需求。
- **模块排列和交互的调整**（Adjustments in Module Arrangement and Interaction）：如Demonstrate-Search-Predict（DSP）框架和ITER-RETGEN的迭代检索-读取-生成流程，展示了模块输出的动态使用，以强化其他模块的功能。

模块化RAG流程的灵活编排展示了通过FLARE和Self-RAG等技术实现的适应性检索的好处。这种方法超越了固定的RAG检索过程，通过评估不同场景下检索的必要性。RAG系统的另一个好处是其灵活架构可以更容易地整合其他技术（如微调或强化学习）。例如，这可以包括微调检索器以获得更好的检索结果，微调生成器以生成更个性化的输出，或进行协同微调。

### 模块化RAG与其他技术的整合

模块化RAG允许将最新的技术和方法整合到现有的RAG框架中，从而进一步提高系统的性能和适应性：

- **微调**（Fine-tuning）：在模块化RAG中，可以对特定模块进行微调，从而提高其在特定任务中的表现。例如，通过对检索器进行微调，可以提高检索结果的准确性；通过对生成器进行微调，可以生成更符合特定需求的输出。
- **强化学习**（Reinforcement Learning）：通过引入强化学习，可以利用反馈机制不断优化RAG系统的表现。例如，可以通过强化学习训练检索器和生成器，使其输出更加贴近用户需求。
- **跨模态检索**（Cross-Modal Retrieval）：模块化RAG可以整合跨模态检索技术，处理多种数据类型（如文本、图像、视频等），从而扩展系统的应用范围。

### 应用场景

模块化RAG的灵活性和适应性使其适用于广泛的应用场景：

- **知识密集型任务**：如医学、法律等领域，需要高精度和高相关性的检索和生成。
- **动态信息更新**：如新闻和社交媒体，要求系统能够快速整合最新的信息。
- **多模态数据处理**：如跨语言翻译、图像描述生成等，需要处理多种数据类型的任务。

通过引入模块化RAG，系统能够更好地适应不同的应用需求，提高生成内容的准确性和相关性，从而在实际应用中发挥更大的作用。
